# 渲染
执行这个过程之前，页面会白屏
渲染进程主要渲染html，css，执行js

主要有**构建dom树**，**样式计算**，**布局阶段**，**分层**，**绘制**，**分块**，**光栅化**，**合成**。

## 构建dom树

可以理解这个过程是把html文件变成document·，生成domtree。

## 样式计算

上一步已经生成了树，但是没有dom节点的样式，这个流程可以分为三步完成。
### 把css转化为浏览器可以理解的结构
把css文本转化为 stylesheet。

### 转化样式表的属性值，使其标准化
例如 把 white 转化为 rgb(255,255,255),em -> px, bold -> 700

### 计算dom元素样式。
这个阶段最终输出的内容是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内

## 构建布局
dom 和 computedstyle 都有了，创建布局树。遍历dom中的可见节点，添加到布局树中，不可见节点则会被忽略。

## 分层
布局树创建好了并不能直接绘制，因为页面中还有一些负责的效果，类似滚动，z-index，z轴变换，3d变换等，渲染引擎还需要为这些特定效果的节点准备图层，并生成一个相应的图层树，layertree，

- 什么样的节点会创建一个单独的图层？
1. 拥有层叠上下文属性的元素会被单独提升为一层。
什么是层叠上下文属性
html, opcity, fixed, will-change, z-index,
(等等)[https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context]

2. 需要裁剪的元素，
比如文本展示区域小于文本的大小，渲染引擎则会为文字部分单独创建一个层，如果出现滚动条，滚动条也会是一个单独的层。

## 绘制
绘制则是根据图层树，按照图层顺序，把一个图层拆成很多的绘制指令，再把绘制指令生成绘制列表

## 栅格化

渲染主线程处理好绘制列表之后，会把绘制列表提交给合成线程。

合成线程讲图层分成图块。大小通常是256x256 512x512

从viewport的附近开始的图块，开始生成位图，生成的操作实际上是由栅格化线程池来执行。栅格化线程使用gpu来生成位图，生成的位图保存在gpu的内存中

## 合成与现实

所有图层完成光栅化后，合成线程就会有一个绘制图块的命令 drawuad提交给浏览器主线程。主线程根据drawquad命令，将页面绘制在gpu内存中，最后现实到屏幕上。


